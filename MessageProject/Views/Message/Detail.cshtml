@model MessageProject.Models.Message

@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
     ViewData["Title"] = "Message  Page";
}
<div id="app" data-identity-name="@User.Identity.Name">
    

    <div style="text-align: center;" >
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="margin: 0 auto; width: 70%; display: flex;">
                <h3>{{messages.title}}</h3>
                <div v-if="IsAdmin">
                    <div style="margin-left: auto;">
                        <button id="messageEdit" type="button" v-on:click="MessageEdit()">編輯</button>
                        <button id="messageSubmit" type="button" v-on:click="MessageSubmit(messages.id)" class="d-none">完成</button>
                    </div>                    
                </div>
            </div>
        </div>
        <div>
            <textarea id="messageTextarea" style="height: 150px;width: 70%;" readonly>{{messages.content}}</textarea>
        </div>
    </div>

    <div v-for="reply in messages.replys" :key="reply.id" :id="'reply_' + reply.id" style="margin-top:10px">
        <div style="margin:0px auto;width: 70%; display: flex">
            <div style="vertical-align: top;width: 18%">{{ reply.userName }}</div>
            <textarea :id="'textarea_' + reply.id" style="height: auto;width: 72%" readonly>{{ reply.replyContent }}</textarea>
            <div :name="'replyButton_' + reply.userName" class="d-none" style="width: 10%">
                <button :id="'replyEdit_' + reply.id" :name="reply.userName" v-on:click="EditContent(reply.id)">編輯</button>
                <button :id="'replySubmit_' + reply.id" :name="reply.userName" v-on:click="EditSubmit(reply.id)" class="d-none">完成</button>
                <button :name="reply.userName" v-on:click="DeleteReply(reply.id)">刪除</button>
            </div>
        </div>
    </div>
    <hr >  
    <div class="reply" style="text-align: center;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="margin:0px auto;width: 70%; display: flex">
                <textarea id="replyTextarea" style="height: auto;width: 100%" placeholder="回覆内容"></textarea>
                <button v-on:click="PostReply()">回覆</button>
            </div>
        </div>
    </div>
</div>
<script>
    var identityName = @Json.Serialize(User.Identity.Name);
    const app = Vue.createApp({
        el: "#app",
        data() {
            return {
                messages: [],
                IsAdmin: false,
                Id: @ViewBag.Id,
                identityName:"",
            }
        },
        created() {
            this.GetDetailContent()
            this.identityName = document.getElementById('app').getAttribute('data-identity-name');
        },
        methods: {
            PostReply() {
                var id=this.messages.id;
                const content = $("#replyTextarea").val();
                $.ajax({
                    url: "/Message/CreateReplyMessage",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        "MessageId": id,
                        "ReplyContent": content,
                    }),
                    success: function (data) {
                        window.location.reload();
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            },
            EditContent(id) {
                $("#textarea_" + id).prop("readonly", false);
                $("#replyEdit_" + id).addClass("d-none");
                $("#replySubmit_" + id).removeClass("d-none");
            },
            EditSubmit(id) {
                $("#textarea_" + id).prop("readonly", true);
                $("#replyEdit_" + id).removeClass("d-none");
                $("#replySubmit_" + id).addClass("d-none");
                const content = $("#textarea_" + id).val();
                $.ajax({
                    url: "/Message/UpdateReply",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        "Id": id,
                        "ReplyContent": content,
                    }),
                    success: function (data) {
                        console.log(data);
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            },
            DeleteReply(id) {
                $.ajax({
                    url: "/Message/DeleteReply/"+id,
                    type: "POST",
                    contentType: "application/json",
                    success: function (data) {
                        $("#reply_" + id).remove();
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            },
            GetUserPerssion() {
                const self = this;
                $.ajax({
                    url: "/Message/GetUserPerssion",
                    type: "Get",
                    contentType: "application/json",
                    success: function (data) {
                        if (data == "all") {
                            $("[name^='replyButton_']").removeClass("d-none");
                            self.IsAdmin = true
                        } else {
                            const userName = self.messages.userName;
                            self.IsAdmin = (self.identityName === userName);
                            $("[name='replyButton_" + data + "']").removeClass("d-none");
                        }                        
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            },
            MessageEdit() {
                $("#messageTextarea").prop("readonly", false);
                $("#messageSubmit").removeClass("d-none");
                $("#messageEdit").addClass("d-none");
            },
            MessageSubmit(id) {                
                const content = $("#messageTextarea").val();
                $.ajax({
                    url: "/Message/UpdateMessage",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        "Id": id,
                        "Content": content,
                    }),
                    success: function (data) {
                        $("#messageTextarea").prop("readonly",true);
                        $("#messageSubmit").addClass("d-none");
                        $("#messageEdit").removeClass("d-none");
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            },
            GetDetailContent() {
                const self = this;
                $.ajax({
                    url: "/Message/GetDetail/" + this.Id,
                    type: "POST",
                    contentType: "application/json",
                    success: function (data) {
                        self.messages = data;
                        self.GetUserPerssion();
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            },
        },
    });
    app.mount("#app");
</script>

       